<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Conjugaison ‚Äì Enfant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg-main: #e0f2fe;
      --bg-gradient-1: #eef2ff;
      --bg-gradient-2: #e0f2fe;

      --card-light: #ffffff;
      --card-soft: #f8fafc;

      --accent: #fb923c;
      --accent-strong: #ea580c;
      --accent-soft: #fed7aa;
      --accent-alt: #22c55e;
      --accent-blue: #3b82f6;

      --text-main: #0f172a;
      --text-muted: #64748b;

      --border-subtle: rgba(148, 163, 184, 0.6);

      --radius-lg: 20px;
      --radius-pill: 999px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, var(--bg-gradient-1), var(--bg-main)),
        radial-gradient(circle at bottom, var(--bg-gradient-2), #ffffff);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(90deg, #1e293b, #0f172a);
      color: #f9fafb;
      padding: 0.8rem 1.4rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.6);
    }

    .header-inner {
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      background: #fef3c7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #b45309;
    }

    .header-title {
      font-size: 1.1rem;
      font-weight: 650;
    }

    .header-sub {
      font-size: 0.85rem;
      color: #cbd5f5;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .stars-pill {
      border-radius: var(--radius-pill);
      padding: 0.2rem 0.7rem;
      background: rgba(250, 204, 21, 0.2);
      border: 1px solid rgba(250, 204, 21, 0.8);
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: #facc15;
    }

    .stars-pill span.num {
      font-weight: 700;
      color: #fefce8;
    }

    .btn-retour {
      border: none;
      padding: 0.4rem 1rem;
      border-radius: var(--radius-pill);
      background: radial-gradient(circle at top left, rgba(59,130,246,0.3), rgba(15, 23, 42, 1));
      color: #e0f2fe;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .btn-retour span.icon { font-size: 1rem; }

    main { flex: 1; }

    .page {
      max-width: 980px;
      margin: 1.2rem auto 1.8rem;
      padding: 0 1rem;
    }

    .hero {
      background: linear-gradient(135deg, #fef3c7, #fee2e2);
      border-radius: var(--radius-lg);
      padding: 1rem 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18);
    }

    .hero-text { font-size: 0.95rem; }

    .hero-badge {
      border-radius: var(--radius-pill);
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.4);
      padding: 0.4rem 0.7rem;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .card {
      background: var(--card-light);
      border-radius: var(--radius-lg);
      padding: 1rem 1.2rem;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.16);
      border: 1px solid var(--border-subtle);
      margin-bottom: 1rem;
    }

    .card h2 {
      font-size: 1rem;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .card h2 .icon { font-size: 1.2rem; }

    .info-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.7rem;
    }

    .info-pill {
      border-radius: var(--radius-pill);
      background: #e0f2fe;
      padding: 0.25rem 0.7rem;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-alt);
    }

    .progress {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 0.8rem;
    }

    .progress-inner {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
      transition: width 0.25s ease-out;
    }

    #instruction {
      font-size: 0.95rem;
      margin-bottom: 0.4rem;
    }

    #currentQuestion {
      font-size: 0.95rem;
      margin-bottom: 0.6rem;
      color: var(--text-muted);
    }

    #answerInput {
      width: 100%;
      padding: 0.45rem 0.7rem;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    #answerInput:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 1px rgba(251,146,60,0.7);
    }

    .btn-main {
      border-radius: var(--radius-pill);
      border: none;
      padding: 0.45rem 1.1rem;
      background: linear-gradient(120deg, var(--accent), var(--accent-strong));
      color: #fefce8;
      font-weight: 650;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      margin-right: 0.4rem;
    }

    #feedback {
      margin-top: 0.5rem;
      font-weight: 600;
      min-height: 1.2rem;
    }

    #result { display: none; }

    #finalScore {
      font-size: 1rem;
      font-weight: 650;
      margin-bottom: 0.4rem;
    }

    #starsGain {
      font-size: 0.9rem;
      margin-bottom: 0.4rem;
    }

    #mistakes {
      padding-left: 1.1rem;
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
    }

    #mistakes li { margin-bottom: 0.2rem; }

    .warning {
      font-size: 0.95rem;
      color: #b91c1c;
    }

    a:focus-visible,
    button:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--accent-blue);
      outline-offset: 2px;
    }
  </style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="header-left">
      <div class="header-icon">‚úèÔ∏è</div>
      <div>
        <div class="header-title">Conjugaison</div>
        <div class="header-sub">Conjugue les verbes pr√©par√©s par ton parent (temps m√©lang√©s).</div>
      </div>
    </div>
    <div class="header-right">
      <div class="stars-pill">
        ‚≠ê <span class="num" id="starCount">0</span>
      </div>
      <a href="boutique.html">
        <button class="btn-retour" type="button">
          <span class="icon">‚≠ê</span>
          <span>Boutique</span>
        </button>
      </a>
      <a href="enfant_index.html">
        <button class="btn-retour" type="button">
          <span class="icon">‚üµ</span>
          <span>Accueil enfant</span>
        </button>
      </a>
    </div>
  </div>
</header>

<main>
  <div class="page">

    <section class="hero">
      <div class="hero-text">
        <strong>Mission conjugaison</strong><br>
        Lis la consigne, √©cris la forme correcte (pronom + verbe), puis clique sur <strong>‚ÄúValider‚Äù</strong>.
      </div>
      <div class="hero-badge">
        <span>üéØ</span>
        <span>Temps m√©lang√©s</span>
      </div>
    </section>

    <section class="card" id="exerciseSection">
      <h2><span class="icon">üß†</span> Exercice</h2>
      <p id="noConfigMessage" class="warning" style="display:none;">
        Aucun exercice n‚Äôest pr√™t pour l‚Äôinstant. Demande √† ton parent de pr√©parer une s√©ance dans l‚ÄôEspace Parent.
      </p>

      <div id="exerciseContent" style="display:none;">
        <div class="info-bar">
          <div class="info-pill">
            <span class="dot"></span>
            <span>Question <span id="questionIndex">0</span> / <span id="questionTotal">0</span></span>
          </div>
          <div class="info-pill">
            <span class="dot" style="background: var(--accent-alt);"></span>
            <span>Score : <span id="score">0</span></span>
          </div>
        </div>

        <div class="progress">
          <div class="progress-inner" id="progressInner"></div>
        </div>

        <p id="instruction">
          Conjugue le verbe demand√© au temps indiqu√©, en √©crivant <strong>toute la forme</strong> (pronom + verbe).
        </p>
        <p id="currentQuestion"></p>

        <input type="text" id="answerInput" autocomplete="off" spellcheck="false"
               placeholder="√âcris ici la forme conjugu√©e‚Ä¶" />
        <button class="btn-main" id="btnValidate" type="button">Valider</button>

        <p id="feedback"></p>
      </div>
    </section>

    <section class="card" id="result">
      <h2><span class="icon">üìä</span> R√©sultat de ta s√©ance</h2>
      <p id="finalScore"></p>
      <p id="starsGain"></p>
      <ul id="mistakes"></ul>
      <button class="btn-main" id="btnRestart" type="button">Recommencer la s√©ance</button>
    </section>

  </div>
</main>

<script>
  const CONJ_CONFIG_KEY = "conjConfig_v1";
  const CONJ_RESULTS_KEY = "conjResults_v1";

  const STARS_KEY = "stars_v1";
  const THEMES_OWNED_KEY = "themes_owned_v1";
  const THEME_ACTIVE_KEY = "theme_active_v1";

  const pronouns = ["je", "tu", "il / elle", "nous", "vous", "ils / elles"];
  const pronounShort = ["je", "tu", "il", "nous", "vous", "ils"];

  const verbsPool = [
    "parler", "aimer", "regarder", "jouer", "chanter", "manger", "travailler", "habiter",
    "finir", "choisir", "grandir", "r√©ussir",
    "vendre", "attendre", "r√©pondre",
    "√™tre", "avoir", "aller", "faire", "venir", "prendre", "voir", "pouvoir", "vouloir"
  ];

  const irregularVerbs = {
    "√™tre": {
      present: ["suis","es","est","sommes","√™tes","sont"],
      imparfait: ["√©tais","√©tais","√©tait","√©tions","√©tiez","√©taient"],
      futur: ["serai","seras","sera","serons","serez","seront"],
      pp: "√©t√©",
      aux: "avoir"
    },
    "avoir": {
      present: ["ai","as","a","avons","avez","ont"],
      imparfait: ["avais","avais","avait","avions","aviez","avaient"],
      futur: ["aurai","auras","aura","aurons","aurez","auront"],
      pp: "eu",
      aux: "avoir"
    },
    "aller": {
      present: ["vais","vas","va","allons","allez","vont"],
      imparfait: ["allais","allais","allait","allions","alliez","allaient"],
      futur: ["irai","iras","ira","irons","irez","iront"],
      pp: "all√©",
      aux: "etre"
    },
    "faire": {
      present: ["fais","fais","fait","faisons","faites","font"],
      imparfait: ["faisais","faisais","faisait","faisions","faisiez","faisaient"],
      futur: ["ferai","feras","fera","ferons","ferez","feront"],
      pp: "fait",
      aux: "avoir"
    },
    "venir": {
      present: ["viens","viens","vient","venons","venez","viennent"],
      imparfait: ["venais","venais","venait","venions","veniez","venaient"],
      futur: ["viendrai","viendras","viendra","viendrons","viendrez","viendront"],
      pp: "venu",
      aux: "etre"
    },
    "prendre": {
      present: ["prends","prends","prend","prenons","prenez","prennent"],
      imparfait: ["prenais","prenais","prenait","prenions","preniez","prenaient"],
      futur: ["prendrai","prendras","prendra","prendrons","prendrez","prendront"],
      pp: "pris",
      aux: "avoir"
    },
    "voir": {
      present: ["vois","vois","voit","voyons","voyez","voient"],
      imparfait: ["voyais","voyais","voyait","voyions","voyiez","voyaient"],
      futur: ["verrai","verras","verra","verrons","verrez","verront"],
      pp: "vu",
      aux: "avoir"
    },
    "pouvoir": {
      present: ["peux","peux","peut","pouvons","pouvez","peuvent"],
      imparfait: ["pouvais","pouvais","pouvait","pouvions","pouviez","pouvaient"],
      futur: ["pourrai","pourras","pourra","pourrons","pourrez","pourront"],
      pp: "pu",
      aux: "avoir"
    },
    "vouloir": {
      present: ["veux","veux","veut","voulons","voulez","veulent"],
      imparfait: ["voulais","voulais","voulait","voulions","vouliez","voulaient"],
      futur: ["voudrai","voudras","voudra","voudrons","voudrez","voudront"],
      pp: "voulu",
      aux: "avoir"
    }
  };

  const presentAvoir = ["ai","as","a","avons","avez","ont"];
  const presentEtre  = ["suis","es","est","sommes","√™tes","sont"];

  const THEMES = {
    default: {
      "--bg-main": "#e0f2fe",
      "--bg-gradient-1": "#eef2ff",
      "--bg-gradient-2": "#e0f2fe",
      "--card-light": "#ffffff",
      "--card-soft": "#f8fafc",
      "--accent": "#fb923c",
      "--accent-strong": "#ea580c",
      "--accent-soft": "#fed7aa",
      "--accent-alt": "#22c55e",
      "--accent-blue": "#3b82f6",
      "--text-main": "#0f172a",
      "--text-muted": "#64748b"
    },
    arc_en_ciel: {
      "--bg-main": "#ffeef7",
      "--bg-gradient-1": "#fee2e2",
      "--bg-gradient-2": "#fef9c3",
      "--accent": "#ec4899",
      "--accent-strong": "#db2777",
      "--accent-soft": "#f9a8d4",
      "--accent-alt": "#22c55e",
      "--accent-blue": "#6366f1"
    },
    foret_magique: {
      "--bg-main": "#dcfce7",
      "--bg-gradient-1": "#bbf7d0",
      "--bg-gradient-2": "#fefce8",
      "--accent": "#22c55e",
      "--accent-strong": "#15803d",
      "--accent-soft": "#bbf7d0",
      "--accent-alt": "#16a34a",
      "--accent-blue": "#0ea5e9"
    },
    glacier_bleu: {
      "--bg-main": "#e0f2fe",
      "--bg-gradient-1": "#dbeafe",
      "--bg-gradient-2": "#f5f3ff",
      "--accent": "#0ea5e9",
      "--accent-strong": "#0369a1",
      "--accent-soft": "#bae6fd",
      "--accent-alt": "#22c55e",
      "--accent-blue": "#2563eb"
    },
    galaxie: {
      "--bg-main": "#020617",
      "--bg-gradient-1": "#1e293b",
      "--bg-gradient-2": "#020617",
      "--card-light": "#0b1220",
      "--card-soft": "#020617",
      "--accent": "#6366f1",
      "--accent-strong": "#4f46e5",
      "--accent-soft": "#a5b4fc",
      "--accent-alt": "#facc15",
      "--accent-blue": "#4f46e5",
      "--text-main": "#e5e7eb",
      "--text-muted": "#9ca3af"
    },
    studio_savoirs: {
      "--bg-main": "#e5e7eb",
      "--bg-gradient-1": "#f5f3ff",
      "--bg-gradient-2": "#fef9c3",
      "--card-light": "#f9fafb",
      "--card-soft": "#f3f4f6",
      "--accent": "#f97316",
      "--accent-strong": "#ea580c",
      "--accent-soft": "#fed7aa",
      "--accent-alt": "#22c55e",
      "--accent-blue": "#3b82f6",
      "--text-main": "#111827",
      "--text-muted": "#6b7280"
    }
  };

  let questions = [];
  let currentIndex = 0;
  let score = 0;
  let mistakes = [];

  const noConfigMessage = document.getElementById("noConfigMessage");
  const exerciseContent = document.getElementById("exerciseContent");
  const questionIndexSpan = document.getElementById("questionIndex");
  const questionTotalSpan = document.getElementById("questionTotal");
  const scoreSpan = document.getElementById("score");
  const progressInner = document.getElementById("progressInner");
  const answerInput = document.getElementById("answerInput");
  const feedback = document.getElementById("feedback");
  const btnValidate = document.getElementById("btnValidate");
  const resultSection = document.getElementById("result");
  const finalScoreSpan = document.getElementById("finalScore");
  const starsGainP = document.getElementById("starsGain");
  const mistakesList = document.getElementById("mistakes");
  const currentQuestionEl = document.getElementById("currentQuestion");
  const btnRestart = document.getElementById("btnRestart");

  function getStars() {
    const v = parseInt(localStorage.getItem(STARS_KEY) || "0", 10);
    return isNaN(v) ? 0 : v;
  }

  function setStars(v) {
    const value = Math.max(0, v);
    localStorage.setItem(STARS_KEY, String(value));
    updateStarDisplay();
  }

  function addStars(n) {
    const current = getStars();
    setStars(current + n);
    return n;
  }

  function updateStarDisplay() {
    const el = document.getElementById("starCount");
    if (el) el.textContent = getStars();
  }

  function ensureThemeDefaults() {
    const raw = localStorage.getItem(THEMES_OWNED_KEY);
    if (!raw) {
      localStorage.setItem(THEMES_OWNED_KEY, JSON.stringify(["default"]));
    }
    if (!localStorage.getItem(THEME_ACTIVE_KEY)) {
      localStorage.setItem(THEME_ACTIVE_KEY, "default");
    }
  }

  function applyThemeFromStorage() {
    let active = localStorage.getItem(THEME_ACTIVE_KEY) || "default";
    const theme = THEMES[active] || THEMES.default;
    const root = document.documentElement;
    Object.entries(theme).forEach(([k, v]) => {
      root.style.setProperty(k, v);
    });
  }

  function getTenseLabel(code) {
    switch (code) {
      case "present": return "pr√©sent de l‚Äôindicatif";
      case "imparfait": return "imparfait de l‚Äôindicatif";
      case "passe_compose": return "pass√© compos√© de l‚Äôindicatif";
      case "futur": return "futur simple de l‚Äôindicatif";
      default: return code;
    }
  }

  function loadConjConfig() {
    const saved = localStorage.getItem(CONJ_CONFIG_KEY);
    if (!saved) return null;
    try { return JSON.parse(saved); } catch (e) { return null; }
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function buildRandomQuestions(cfg) {
    const tenses = (cfg && Array.isArray(cfg.tenses) && cfg.tenses.length)
      ? cfg.tenses
      : ["present"];
    const persons = (cfg && Array.isArray(cfg.persons) && cfg.persons.length)
      ? cfg.persons
      : [0,1,2,3,4,5];
    const count = (cfg && typeof cfg.questionCount === "number")
      ? cfg.questionCount
      : 10;

    const qs = [];
    for (let i = 0; i < count; i++) {
      const verb = verbsPool[Math.floor(Math.random() * verbsPool.length)];
      const tense = tenses[Math.floor(Math.random() * tenses.length)];
      const personIndex = persons[Math.floor(Math.random() * persons.length)];
      qs.push({ verb, tense, personIndex });
    }
    return qs;
  }

  function conjugateRegular(verb, tense, personIndex) {
    const infinitive = verb.toLowerCase();
    const endsWith = (suffix) => infinitive.endsWith(suffix);
    let group = "er";
    if (endsWith("ir")) group = "ir";
    if (endsWith("re")) group = "re";
    if (!endsWith("er") && !endsWith("ir") && !endsWith("re")) group = "other";

    if (tense === "present") {
      if (group === "er") {
        const stem = infinitive.slice(0, -2);
        const endings = ["e","es","e","ons","ez","ent"];
        let form = stem + endings[personIndex];
        if (infinitive === "manger" && personIndex === 3) form = "mangeons";
        return form;
      } else if (group === "ir") {
        const stem = infinitive.slice(0, -2);
        const endings = ["is","is","it","issons","issez","issent"];
        return stem + endings[personIndex];
      } else if (group === "re") {
        const stem = infinitive.slice(0, -2);
        const endings = ["s","s","","ons","ez","ent"];
        return stem + endings[personIndex];
      } else {
        const stem = infinitive.slice(0, -2);
        const endings = ["e","es","e","ons","ez","ent"];
        return stem + endings[personIndex];
      }
    }

    if (tense === "imparfait") {
      let imparfaitStem = "";
      if (group === "er" || group === "re") {
        imparfaitStem = infinitive.slice(0, -2);
      } else if (group === "ir") {
        const stem = infinitive.slice(0, -2);
        imparfaitStem = stem + "iss";
      } else {
        imparfaitStem = infinitive.slice(0, -2);
      }
      const endings = ["ais","ais","ait","ions","iez","aient"];
      return imparfaitStem + endings[personIndex];
    }

    if (tense === "futur") {
      let base = infinitive;
      if (group === "re") {
        base = infinitive.slice(0, -1);
      }
      const endings = ["ai","as","a","ons","ez","ont"];
      return base + endings[personIndex];
    }

    if (tense === "pp") {
      const stem = infinitive.slice(0, -2);
      if (group === "er") return stem + "√©";
      if (group === "ir") return stem + "i";
      if (group === "re") return stem + "u";
      return infinitive;
    }

    return infinitive;
  }

  function buildExpectedForm(verb, tense, personIndex) {
    const vLower = verb.toLowerCase();
    const ir = irregularVerbs[vLower];
    const pronoun = pronounShort[personIndex];

    if (tense === "present" || tense === "imparfait" || tense === "futur") {
      let verbForm;
      if (ir) {
        const key = (tense === "futur") ? "futur" : tense;
        verbForm = ir[key][personIndex];
      } else {
        verbForm = conjugateRegular(vLower, tense, personIndex);
      }

      if (personIndex === 0) {
        if (/^[aeiouyh√¢√™√Æ√¥√ª√§√´√Ø√∂√º√©√®√™√´]/i.test(verbForm)) {
          return "j'" + verbForm;
        }
        return "je " + verbForm;
      }
      return pronoun + " " + verbForm;
    }

    if (tense === "passe_compose") {
      let pp, auxType = "avoir";

      if (ir) {
        pp = ir.pp;
        auxType = ir.aux || "avoir";
      } else {
        pp = conjugateRegular(vLower, "pp", personIndex);
        auxType = "avoir";
      }

      const auxPresent = (auxType === "etre") ? presentEtre : presentAvoir;
      let auxWord = auxPresent[personIndex];
      let phrase;

      if (personIndex === 0) {
        if (/^[aeiouyh√¢√™√Æ√¥√ª√§√´√Ø√∂√º√©√®√™√´]/i.test(auxWord)) {
          phrase = "j'" + auxWord + " " + pp;
        } else {
          phrase = "je " + auxWord + " " + pp;
        }
      } else {
        phrase = pronoun + " " + auxWord + " " + pp;
      }

      return phrase;
    }

    return vLower;
  }

  function saveResults() {
    const stored = localStorage.getItem(CONJ_RESULTS_KEY);
    let list = [];
    if (stored) {
      try { list = JSON.parse(stored) || []; } catch (e) { list = []; }
    }

    const total = questions.length;
    const result = {
      date: new Date().toISOString(),
      score: score,
      total: total,
      mistakes: mistakes
    };

    list.push(result);
    localStorage.setItem(CONJ_RESULTS_KEY, JSON.stringify(list));
  }

  function normalizeText(str) {
    return str
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ");
  }

  function showCurrentQuestion() {
    const q = questions[currentIndex];
    const tenseLabel = getTenseLabel(q.tense);

    questionIndexSpan.textContent = currentIndex + 1;
    questionTotalSpan.textContent = questions.length;

    const pLabel = pronouns[q.personIndex];
    currentQuestionEl.textContent =
      "Conjugue le verbe ¬´ " + q.verb + " ¬ª au " + tenseLabel +
      " avec ¬´ " + pLabel + " ¬ª.";

    const progress = (currentIndex / questions.length) * 100;
    progressInner.style.width = progress + "%";

    answerInput.value = "";
    answerInput.focus();
    feedback.textContent = "";
  }

  function validateAnswer() {
    if (currentIndex >= questions.length) return;

    const q = questions[currentIndex];
    const userInput = answerInput.value;

    if (!userInput.trim()) {
      feedback.textContent = "√âcris d‚Äôabord ta r√©ponse üòâ";
      return;
    }

    const tenseLabel = getTenseLabel(q.tense);
    const expected = buildExpectedForm(q.verb, q.tense, q.personIndex);

    const normalizedExpected = normalizeText(expected);
    const normalizedUser = normalizeText(userInput);

    if (normalizedExpected === normalizedUser) {
      score++;
      scoreSpan.textContent = score;
      feedback.textContent = "Bravo, c‚Äôest correct ! üéâ";
    } else {
      feedback.textContent = "Presque ! La bonne r√©ponse √©tait : ¬´ " + expected + " ¬ª";
      mistakes.push({
        verb: q.verb,
        tense: q.tense,
        tenseLabel: tenseLabel,
        personIndex: q.personIndex,
        personLabel: pronouns[q.personIndex],
        expected: expected,
        answer: userInput
      });
    }

    currentIndex++;

    if (currentIndex < questions.length) {
      setTimeout(showCurrentQuestion, 2200);
    } else {
      finishExercise();
    }
  }

  function finishExercise() {
    progressInner.style.width = "100%";

    exerciseContent.style.display = "none";
    resultSection.style.display = "block";

    const total = questions.length;
    finalScoreSpan.textContent = "Tu as " + score + " bonne(s) r√©ponse(s) sur " + total + ".";

    mistakesList.innerHTML = "";
    if (mistakes.length === 0) {
      const li = document.createElement("li");
      li.textContent = "Aucune erreur, super travail ! üåü";
      mistakesList.appendChild(li);
    } else {
      mistakes.forEach(m => {
        const li = document.createElement("li");
        li.textContent =
          m.verb + " ‚Äì " + m.tenseLabel + " ‚Äì " + m.personLabel +
          " : tu as √©crit ¬´ " + m.answer + " ¬ª au lieu de ¬´ " + m.expected + " ¬ª";
        mistakesList.appendChild(li);
      });
    }

    saveResults();

    // ‚≠ê R√©compense : 3 √©toiles + 2 si aucune erreur
    let gained = 3;
    if (mistakes.length === 0) {
      gained += 2;
    }
    addStars(gained);
    starsGainP.textContent = "Tu as gagn√© " + gained + " √©toile(s) ‚≠ê pour la boutique !";
  }

  function initExercise() {
    const cfg = loadConjConfig();
    if (!cfg || !Array.isArray(cfg.tenses) || cfg.tenses.length === 0) {
      noConfigMessage.style.display = "block";
      exerciseContent.style.display = "none";
      resultSection.style.display = "none";
      return;
    }

    questions = buildRandomQuestions(cfg);
    if (!questions.length) {
      noConfigMessage.style.display = "block";
      exerciseContent.style.display = "none";
      resultSection.style.display = "none";
      return;
    }

    currentIndex = 0;
    score = 0;
    mistakes = [];

    noConfigMessage.style.display = "none";
    exerciseContent.style.display = "block";
    resultSection.style.display = "none";

    scoreSpan.textContent = score;
    showCurrentQuestion();
  }

  btnValidate.addEventListener("click", validateAnswer);
  answerInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") validateAnswer();
  });
  btnRestart.addEventListener("click", () => {
    initExercise();
  });

  function init() {
    ensureThemeDefaults();
    applyThemeFromStorage();
    updateStarDisplay();
    initExercise();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
</script>

</body>
</html>
