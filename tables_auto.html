<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Math√©matiques ‚Äì Tables de multiplication</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  /* Palette claire */
  --bg-main: #e0f2fe;
  --bg-gradient-1: #eef2ff;
  --bg-gradient-2: #e0f2fe;

  --card-light: #ffffff;
  --card-soft: #f1f5f9;

  --accent: #fb923c;
  --accent-strong: #ea580c;
  --accent-soft: #fed7aa;
  --accent-alt: #22c55e;
  --accent-purple: #a855f7;
  --accent-blue: #3b82f6;

  --text-main: #0f172a;
  --text-muted: #64748b;

  --border-subtle: rgba(148, 163, 184, 0.5);

  --radius-lg: 22px;
  --radius-xxl: 30px;
  --radius-pill: 999px;

  --shadow-hard: 0 24px 50px rgba(15, 23, 42, 0.15);
  --shadow-soft: 0 16px 35px rgba(15, 23, 42, 0.12);
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background:
    radial-gradient(circle at top, var(--bg-gradient-1), var(--bg-main)),
    radial-gradient(circle at bottom, var(--bg-gradient-2), #ffffff);
  color: var(--text-main);
  display: flex;
  flex-direction: column;
}

/* === HEADER (on garde un bandeau un peu plus sombre mais pas noir) === */
.app-header {
  position: sticky;
  top: 0;
  z-index: 20;
  padding: 0.75rem 1.5rem 0.9rem;
  background: linear-gradient(90deg, #1e293b, #0f172a);
  border-bottom: 1px solid rgba(148, 163, 184, 0.5);
  backdrop-filter: blur(18px);
  box-shadow: 0 14px 38px rgba(15, 23, 42, 0.5);
  color: #f9fafb;
}

.header-inner {
  max-width: 1080px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 0.9rem;
}

.header-icon {
  width: 44px;
  height: 44px;
  border-radius: 18px;
  background: radial-gradient(circle at top, #4f46e5, #1e1b4b);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 18px 35px rgba(15, 23, 42, 0.8);
  font-size: 1.8rem;
}

.header-text-main {
  font-size: 1.25rem;
  font-weight: 650;
  letter-spacing: 0.02em;
}

.header-text-sub {
  font-size: 0.85rem;
  color: #cbd5f5;
}

/* Bouton retour */
.header-right a {
  text-decoration: none;
}

.btn-retour {
  border: none;
  padding: 0.55rem 1.15rem;
  border-radius: var(--radius-pill);
  background: radial-gradient(circle at top left, rgba(251, 146, 60, 0.4), rgba(15, 23, 42, 1));
  color: #fefce8;
  font-weight: 600;
  font-size: 0.85rem;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 0.45rem;
  box-shadow:
    0 0 0 1px rgba(251, 146, 60, 0.8),
    0 12px 30px rgba(15, 23, 42, 0.7);
  transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, opacity 0.12s ease;
}

.btn-retour span.icon {
  font-size: 1rem;
}

.btn-retour:hover {
  transform: translateY(-1px);
  background: radial-gradient(circle at top left, rgba(251, 146, 60, 0.7), rgba(15, 23, 42, 1));
  box-shadow:
    0 0 0 1px rgba(251, 146, 60, 0.95),
    0 16px 38px rgba(15, 23, 42, 0.9);
}

/* === LAYOUT PRINCIPAL === */
main {
  flex: 1;
  padding: 1.3rem 1.1rem 1.8rem;
}

.page {
  max-width: 1080px;
  margin: 0 auto;
}

/* === BANDEAU D'INFO + STICKERS BAR === */
.hero-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.9rem;
  margin-bottom: 0.7rem;
}

.hero-card {
  flex: 2 1 260px;
  background: radial-gradient(circle at top left, #ffffff, #e0f2fe);
  border-radius: var(--radius-xxl);
  border: 1px solid rgba(148, 163, 184, 0.5);
  box-shadow: var(--shadow-soft);
  padding: 1rem 1.4rem;
  display: flex;
  gap: 0.9rem;
  align-items: center;
}

.hero-left {
  flex: 1;
}

.hero-title {
  font-size: 1.1rem;
  font-weight: 650;
  margin-bottom: 0.25rem;
}

.hero-sub {
  font-size: 0.9rem;
  color: var(--text-muted);
}

.hero-tagline {
  margin-top: 0.5rem;
  font-size: 0.9rem;
  color: #f97316;
  font-weight: 600;
}

.hero-right {
  width: 90px;
  height: 90px;
  border-radius: 999px;
  background: conic-gradient(from 210deg, #22c55e, #a855f7, #fb923c, #22c55e);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.3);
  position: relative;
  overflow: hidden;
}

.hero-right-inner {
  width: 72px;
  height: 72px;
  border-radius: 999px;
  background: #eff6ff;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #0f172a;
  font-size: 1.1rem;
  font-weight: 700;
}

.hero-mini {
  flex: 1 1 180px;
  background: #f9fafb;
  border-radius: 24px;
  border: 1px dashed rgba(148, 163, 184, 0.7);
  box-shadow: 0 10px 28px rgba(148, 163, 184, 0.25);
  padding: 0.9rem 1rem;
  font-size: 0.85rem;
  color: var(--text-muted);
}

/* BARRE DE STICKERS GAMING */
.sticker-bar {
  margin: 0.3rem 0 1rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.sticker-chip {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.25rem 0.75rem;
  border-radius: 999px;
  font-size: 0.8rem;
  font-weight: 600;
  background: #eff6ff;
  box-shadow: 0 10px 25px rgba(148, 163, 184, 0.45);
}

.sticker-chip span.icon {
  font-size: 1rem;
}

.sticker-xp {
  background: linear-gradient(120deg, #bbf7d0, #6ee7b7);
}

.sticker-combo {
  background: linear-gradient(120deg, #fce7f3, #f9a8d4);
}

.sticker-perfect {
  background: linear-gradient(120deg, #dbeafe, #bfdbfe);
}

/* === ONGLET PARENT / ENFANT === */
.tab-bar {
  margin-top: 0.4rem;
  margin-bottom: 1rem;
  display: inline-flex;
  border-radius: var(--radius-pill);
  padding: 0.18rem;
  background: #e2e8f0;
  box-shadow: 0 10px 22px rgba(148, 163, 184, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.7);
}

.tab-button {
  border: none;
  background: transparent;
  padding: 0.4rem 0.95rem;
  font-size: 0.9rem;
  font-weight: 600;
  border-radius: var(--radius-pill);
  color: var(--text-muted);
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  cursor: pointer;
  transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease;
}

.tab-button span.icon {
  font-size: 1.1rem;
}

.tab-button.active {
  background: linear-gradient(120deg, #fb923c, #f97316);
  color: #fefce8;
  box-shadow:
    0 0 0 1px rgba(248, 250, 252, 0.5),
    0 10px 22px rgba(248, 113, 22, 0.7);
}

.tab-button:hover {
  transform: translateY(-1px);
}

/* === CARTES PRINCIPALES === */
.card {
  background: #ffffff;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-subtle);
  box-shadow: var(--shadow-hard);
  padding: 1.25rem 1.4rem 1.4rem;
  margin-bottom: 1rem;
}

.card h2 {
  margin: 0;
  font-size: 1.05rem;
  font-weight: 650;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.card h2 span.icon {
  font-size: 1.25rem;
}

.card p {
  margin: 0.6rem 0;
  font-size: 0.95rem;
}

/* Mode parent : pastilles de tables */
.tables-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 0.42rem;
  margin-top: 0.4rem;
}

.tables-grid label {
  background: #eff6ff;
  border-radius: 999px;
  padding: 0.25rem 0.7rem;
  border: 1px solid rgba(148, 163, 184, 0.8);
  font-size: 0.85rem;
  color: #0f172a;
  box-shadow: 0 8px 18px rgba(148, 163, 184, 0.4);
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
}

.tables-grid input[type="checkbox"] {
  accent-color: var(--accent);
}

/* Champs et boutons */
label {
  font-size: 0.9rem;
}

input[type="number"],
input[type="text"] {
  padding: 0.45rem 0.65rem;
  margin-top: 0.3rem;
  font-size: 0.95rem;
  border-radius: 14px;
  border: 1px solid rgba(148, 163, 184, 0.8);
  background: #f8fafc;
  color: var(--text-main);
  outline: none;
}

input[type="number"]:focus,
input[type="text"]:focus {
  border-color: #fb923c;
  box-shadow: 0 0 0 1px rgba(251, 146, 60, 0.8);
}

button {
  border-radius: var(--radius-pill);
  border: none;
  padding: 0.55rem 1.2rem;
  background: radial-gradient(circle at top, var(--accent), var(--accent-strong));
  color: #fff;
  font-weight: 650;
  font-size: 0.95rem;
  cursor: pointer;
  box-shadow:
    0 0 0 1px rgba(248, 250, 252, 0.5),
    0 12px 30px rgba(248, 113, 22, 0.7);
  transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
}

button:hover {
  transform: translateY(-1px);
  filter: brightness(1.04);
  box-shadow:
    0 0 0 1px rgba(248, 250, 252, 0.9),
    0 16px 38px rgba(249, 115, 22, 0.8);
}

button:active {
  transform: translateY(0);
  box-shadow:
    0 0 0 1px rgba(249, 250, 251, 0.7),
    0 11px 26px rgba(248, 113, 22, 0.7);
}

/* Message sauvegarde */
#saveStatus {
  font-size: 0.9rem;
  margin-top: 0.4rem;
  color: #ea580c;
  font-weight: 600;
}

/* === MODE ENFANT === */
.child-layout {
  display: grid;
  grid-template-columns: minmax(0, 1.25fr) minmax(0, 0.9fr);
  gap: 1.1rem;
}

@media (max-width: 840px) {
  .child-layout {
    grid-template-columns: 1fr;
  }
}

.child-main {
  position: relative;
  background: radial-gradient(circle at top left, #ffffff, #e0f2fe);
  border-radius: var(--radius-lg);
  border: 1px solid rgba(148, 163, 184, 0.7);
  padding: 1rem 1.1rem 1.1rem;
  box-shadow: 0 18px 42px rgba(148, 163, 184, 0.6);
}

/* STICKERS FLOTTANTS GAMING AUTOUR DE LA QUESTION */
.child-main::before,
.child-main::after {
  content: "";
  position: absolute;
  border-radius: 999px;
  pointer-events: none;
  opacity: 0.65;
}

.child-main::before {
  width: 76px;
  height: 28px;
  top: -14px;
  right: 16px;
  background: linear-gradient(120deg, #22c55e, #bbf7d0);
  box-shadow: 0 12px 25px rgba(34, 197, 94, 0.5);
}

.child-main::after {
  width: 88px;
  height: 30px;
  bottom: -15px;
  left: 18px;
  background: linear-gradient(120deg, #f97316, #fed7aa);
  box-shadow: 0 -10px 22px rgba(249, 115, 22, 0.45);
}

/* Faux stickers texte en overlay */
.child-sticker-top,
.child-sticker-bottom {
  position: absolute;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #064e3b;
  pointer-events: none;
}

.child-sticker-top {
  top: -11px;
  right: 22px;
}

.child-sticker-bottom {
  bottom: -11px;
  left: 24px;
  color: #7c2d12;
}

.child-side {
  background: #f8fafc;
  border-radius: var(--radius-lg);
  border: 1px solid rgba(148, 163, 184, 0.7);
  padding: 1rem 1.1rem 1.1rem;
  box-shadow: 0 14px 30px rgba(148, 163, 184, 0.6);
}

.child-side-title {
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 0.3rem;
}

.child-side-line {
  font-size: 0.88rem;
  color: var(--text-muted);
  margin: 0.2rem 0;
}

.child-side-line span.label {
  color: #0f172a;
  font-weight: 600;
}

/* Info question & score */
.info-bar {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 0.5rem;
  font-size: 0.92rem;
  font-weight: 600;
}

.info-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.22rem 0.7rem;
  border-radius: 999px;
  background: #eff6ff;
  border: 1px solid rgba(148, 163, 184, 0.9);
}

.info-pill span.dot {
  width: 7px;
  height: 7px;
  border-radius: 999px;
  background: #f97316;
}

/* Barre de progression */
.progress {
  width: 100%;
  height: 8px;
  background: #e2e8f0;
  border-radius: 999px;
  overflow: hidden;
  margin: 0.65rem 0 0.8rem;
}

.progress-inner {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--accent), #facc15);
  transition: width 0.2s ease-out;
}

/* Question */
#questionText {
  font-size: 1.35rem;
  font-weight: 700;
  margin-top: 0.4rem;
}

#questionHelp {
  margin-top: 0.15rem;
  font-size: 0.9rem;
  color: var(--text-muted);
}

#answerArea {
  margin-top: 0.8rem;
}

#answerArea input[type="number"] {
  max-width: 130px;
  margin-right: 0.5rem;
}

/* Options QCM */
.quiz-options {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 0.55rem;
}

.quiz-options button {
  width: 100%;
  font-size: 0.95rem;
}

/* Feedback */
#feedback {
  font-weight: 600;
  margin-top: 0.7rem;
  min-height: 1.1rem;
}

/* R√©sultats */
#result {
  margin-top: 0.5rem;
}

#finalScore {
  font-size: 1rem;
  font-weight: 650;
  margin-bottom: 0.4rem;
}

#mistakes {
  padding-left: 1.2rem;
  margin-top: 0.4rem;
}

#mistakes li {
  margin-bottom: 0.25rem;
  font-size: 0.9rem;
}

/* Responsive header */
@media (max-width: 720px) {
  .header-inner {
    flex-direction: column;
    align-items: flex-start;
  }
}

/* Focus visible */
button:focus-visible,
a:focus-visible,
input:focus-visible {
  outline: 2px solid var(--accent-blue);
  outline-offset: 2px;
}
</style>
</head>

<body>

<header class="app-header">
  <div class="header-inner">
    <div class="header-left">
      <div class="header-icon">‚úñÔ∏è</div>
      <div>
        <div class="header-text-main">Tables de multiplication</div>
        <div class="header-text-sub">Un espace parent üë®‚Äçüëß et enfant üß† pour progresser en s‚Äôamusant.</div>
      </div>
    </div>
    <div class="header-right">
      <a href="index.html">
        <button class="btn-retour" type="button">
          <span class="icon">‚üµ</span>
          <span>Retour √† l'accueil</span>
        </button>
      </a>
    </div>
  </div>
</header>

<main>
  <div class="page">

    <!-- Bandeau hero -->
    <div class="hero-row">
      <div class="hero-card">
        <div class="hero-left">
          <div class="hero-title">Entra√Ænement aux tables</div>
          <div class="hero-sub">Choisis les tables dans le mode parent, puis laisse l‚Äôenfant jouer avec les questions.</div>
          <div class="hero-tagline">Astuce : m√©lange les questions directes et ‚ÄúQuel calcul donne 56 ?‚Äù pour un vrai mode gaming.</div>
        </div>
        <div class="hero-right">
          <div class="hero-right-inner">
            <div>
              <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;color:#6b7280;">Mode</div>
              <div style="font-size:1.05rem;">Arcade</div>
            </div>
          </div>
        </div>
      </div>

      <div class="hero-mini">
        Mode d‚Äôemploi rapide :<br>
        1Ô∏è‚É£ Le parent r√®gle les param√®tres.<br>
        2Ô∏è‚É£ La s√©rie de questions d√©marre.<br>
        3Ô∏è‚É£ √Ä la fin, les erreurs sont list√©es pour pouvoir les retravailler.
      </div>
    </div>

    <!-- Barre de stickers -->
    <div class="sticker-bar">
      <div class="sticker-chip sticker-xp">
        <span class="icon">‚ö°</span>
        <span>+10 XP</span>
      </div>
      <div class="sticker-chip sticker-combo">
        <span class="icon">üéÆ</span>
        <span>Combo x3</span>
      </div>
      <div class="sticker-chip sticker-perfect">
        <span class="icon">‚≠ê</span>
        <span>Perfect run</span>
      </div>
    </div>

    <!-- Onglets -->
    <div class="tab-bar">
      <button class="tab-button active" id="tabParent" type="button" onclick="showTab('parent')">
        <span class="icon">üë®‚Äçüëß</span> Mode parent
      </button>
      <button class="tab-button" id="tabChild" type="button" onclick="showTab('child')">
        <span class="icon">üß†</span> Mode enfant
      </button>
    </div>

    <!-- MODE PARENT -->
    <section class="card" id="parentSection">
      <h2><span class="icon">üë®‚Äçüëß</span> R√©glages du parent</h2>

      <p><strong>Tables √† travailler</strong> <span style="font-size:0.85rem;color:var(--text-muted);">(si aucune n‚Äôest coch√©e, 1 √† 10 seront utilis√©es)</span></p>
      <div class="tables-grid" id="tablesParent"></div>

      <p style="margin-top:0.8rem;"><strong>Type de questions</strong> :</p>
      <label><input type="radio" name="mode" value="mixte" checked> Mixte (directes + chercher l‚Äôop√©ration)</label><br>
      <label><input type="radio" name="mode" value="direct"> Questions directes (7 √ó 8 = ?)</label><br>
      <label><input type="radio" name="mode" value="operation"> Chercher l‚Äôop√©ration (Quel calcul donne 56 ?)</label>

      <p style="margin-top:0.8rem;">
        <label>Nombre de questions :
          <input type="number" id="nbQuestions" min="5" max="50" value="15">
        </label>
      </p>

      <p>
        <label>Facteur maximum (jusqu‚Äô√† √ó ‚Ä¶) :
          <input type="number" id="maxFactor" min="5" max="12" value="10">
        </label>
      </p>

      <button onclick="saveConfig()">Enregistrer les r√©glages & lancer</button>
      <p id="saveStatus"></p>
    </section>

    <!-- MODE ENFANT -->
    <section class="card" id="exerciseSection" style="display:none;">
      <h2><span class="icon">üß†</span> Mode enfant ‚Äì Entra√Ænement</h2>
      <p style="font-size:0.95rem;margin-top:0.35rem;">R√©ponds aux questions de tables. Tu peux taper le r√©sultat ou cliquer sur la bonne op√©ration.</p>

      <div class="child-layout">
        <div class="child-main">
          <div class="child-sticker-top">Combo ready</div>
          <div class="child-sticker-bottom">+ XP bonus</div>

          <div class="info-bar">
            <div class="info-pill">
              <span class="dot"></span>
              <span>Question <span id="questionIndex">0</span> / <span id="questionTotal">0</span></span>
            </div>
            <div class="info-pill">
              <span class="dot" style="background:#22c55e;"></span>
              <span>Score : <span id="score">0</span></span>
            </div>
          </div>

          <div class="progress">
            <div class="progress-inner" id="progressInner"></div>
          </div>

          <p id="questionText">Les questions appara√Ætront ici.</p>
          <p id="questionHelp"></p>

          <div id="answerArea"></div>

          <p id="feedback"></p>
        </div>

        <div class="child-side">
          <div class="child-side-title">Profil de la s√©rie</div>
          <p class="child-side-line">
            <span class="label">Tables choisies :</span>
            <span id="sideTables">‚Äì</span>
          </p>
          <p class="child-side-line">
            <span class="label">Type de questions :</span>
            <span id="sideMode">‚Äì</span>
          </p>
          <p class="child-side-line">
            <span class="label">Facteur max :</span>
            <span id="sideMaxFactor">‚Äì</span>
          </p>
          <p class="child-side-line">
            <span class="label">Nombre de questions :</span>
            <span id="sideNbQuestions">‚Äì</span>
          </p>
        </div>
      </div>
    </section>

    <!-- RESULTATS -->
    <section class="card" id="result" style="display:none;">
      <h2><span class="icon">üèÅ</span> R√©sultat de la s√©rie</h2>
      <p id="finalScore"></p>
      <p><strong>Questions √† retravailler :</strong></p>
      <ul id="mistakes"></ul>
      <button onclick="restart()">Recommencer</button>
    </section>

  </div>
</main>

<script>
// ======================== CONFIG / MODE PARENT =========================
var CONFIG_KEY = "tablesConfig_v1";

function showTab(which) {
  var parent = document.getElementById("parentSection");
  var child = document.getElementById("exerciseSection");

  var tabParent = document.getElementById("tabParent");
  var tabChild = document.getElementById("tabChild");

  if (which === "parent") {
    parent.style.display = "block";
    if (child) child.style.display = "none";
    tabParent.classList.add("active");
    tabChild.classList.remove("active");
  } else {
    parent.style.display = "block";
    if (child) child.style.display = "block";
    parent.style.display = "none";
    tabParent.classList.remove("active");
    tabChild.classList.add("active");
  }
}

function saveConfig() {
  var tables = [];
  var boxes = document.querySelectorAll("#tablesParent input[type='checkbox']");
  var i;
  for (i = 0; i < boxes.length; i++) {
    if (boxes[i].checked) {
      tables.push(parseInt(boxes[i].value, 10));
    }
  }
  if (tables.length === 0) {
    // si aucune table coch√©e, on prend tout 1‚Äì10
    for (i = 1; i <= 10; i++) tables.push(i);
  }

  var radios = document.getElementsByName("mode");
  var mode = "mixte";
  for (i = 0; i < radios.length; i++) {
    if (radios[i].checked) {
      mode = radios[i].value;
      break;
    }
  }

  var nb = parseInt(document.getElementById("nbQuestions").value, 10);
  if (isNaN(nb) || nb < 5) nb = 5;
  if (nb > 50) nb = 50;

  var mf = parseInt(document.getElementById("maxFactor").value, 10);
  if (isNaN(mf) || mf < 5) mf = 5;
  if (mf > 12) mf = 12;

  var config = {
    tables: tables,
    mode: mode,
    nbQuestions: nb,
    maxFactor: mf
  };

  localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
  document.getElementById("saveStatus").textContent = "R√©glages enregistr√©s ! La s√©rie d√©marre dans le mode enfant.";
  updateSidePanel(config);
  startExerciseWithConfig(config);
  showTab("child");
}

function loadConfig() {
  var saved = localStorage.getItem(CONFIG_KEY);
  if (!saved) return null;
  try {
    return JSON.parse(saved);
  } catch(e) {
    return null;
  }
}

// initialisation des cases √† cocher tables
function initTablesUI(config) {
  var container = document.getElementById("tablesParent");
  var i;

  for (i = 1; i <= 10; i++) {
    var label = document.createElement("label");
    var cb = document.createElement("input");
    cb.type = "checkbox";
    cb.value = String(i);

    // Par d√©faut : coch√©, sinon on applique la config
    cb.checked = true;
    if (config && config.tables && config.tables.indexOf(i) === -1) {
      cb.checked = false;
    }

    label.appendChild(cb);
    label.appendChild(document.createTextNode(" table de " + i));
    container.appendChild(label);
  }

  // appliquer les autres r√©glages si d√©j√† sauvegard√©s
  if (config) {
    // mode
    var radios = document.getElementsByName("mode");
    for (i = 0; i < radios.length; i++) {
      if (radios[i].value === config.mode) {
        radios[i].checked = true;
      }
    }
    document.getElementById("nbQuestions").value = config.nbQuestions;
    document.getElementById("maxFactor").value = config.maxFactor;
  }
}

// ======================== MODE ENFANT / EXERCICE =========================

var questions = [];
var currentIndex = 0;
var score = 0;
var mistakesList = [];

function randChoice(arr) {
  var idx = Math.floor(Math.random() * arr.length);
  return arr[idx];
}

function shuffleArray(arr) {
  var i, j, tmp;
  for (i = arr.length - 1; i > 0; i--) {
    j = Math.floor(Math.random() * (i + 1));
    tmp = arr[i];
    arr[i] = arr[j];
    arr[j] = tmp;
  }
  return arr;
}

function generateDirectQuestion(tables, maxFactor) {
  var a = randChoice(tables);
  var b = 1 + Math.floor(Math.random() * maxFactor);
  return {
    type: "direct",
    a: a,
    b: b,
    result: a * b
  };
}

function generateOperationQuestion(tables, maxFactor) {
  var base = generateDirectQuestion(tables, maxFactor);
  var correctLabel = base.a + " √ó " + base.b;

  var optionsSet = {};
  var optionsArr = [];

  function addOption(label) {
    if (!optionsSet[label]) {
      optionsSet[label] = true;
      optionsArr.push(label);
    }
  }

  addOption(correctLabel);

  while (optionsArr.length < 4) {
    var fake = generateDirectQuestion(tables, maxFactor);
    addOption(fake.a + " √ó " + fake.b);
  }

  shuffleArray(optionsArr);

  return {
    type: "operation",
    a: base.a,
    b: base.b,
    result: base.result,
    options: optionsArr,
    correctOption: correctLabel
  };
}

// Pr√©pare la liste de questions selon la config
function buildQuestions(config) {
  var list = [];
  var i;
  for (i = 0; i < config.nbQuestions; i++) {
    var typeToUse = config.mode;
    if (config.mode === "mixte") {
      typeToUse = Math.random() < 0.5 ? "direct" : "operation";
    }
    if (typeToUse === "direct") {
      list.push(generateDirectQuestion(config.tables, config.maxFactor));
    } else {
      list.push(generateOperationQuestion(config.tables, config.maxFactor));
    }
  }
  return list;
}

function updateSidePanel(config) {
  if (!config) return;
  document.getElementById("sideTables").textContent = config.tables.join(", ");
  var modeText = "Mixte";
  if (config.mode === "direct") modeText = "Questions directes";
  if (config.mode === "operation") modeText = "Chercher l‚Äôop√©ration";
  document.getElementById("sideMode").textContent = modeText;
  document.getElementById("sideMaxFactor").textContent = config.maxFactor;
  document.getElementById("sideNbQuestions").textContent = config.nbQuestions;
}

function startExerciseWithConfig(config) {
  questions = buildQuestions(config);
  currentIndex = 0;
  score = 0;
  mistakesList = [];

  document.getElementById("score").textContent = "0";
  document.getElementById("questionIndex").textContent = "0";
  document.getElementById("questionTotal").textContent = String(questions.length);
  document.getElementById("feedback").textContent = "";
  document.getElementById("mistakes").innerHTML = "";
  document.getElementById("finalScore").textContent = "";

  document.getElementById("result").style.display = "none";
  document.getElementById("exerciseSection").style.display = "block";

  updateProgress();
  showCurrentQuestion();
}

function updateProgress() {
  var total = questions.length;
  var idx = currentIndex;
  document.getElementById("questionIndex").textContent = String(idx + 1 <= total ? idx + 1 : total);
  document.getElementById("questionTotal").textContent = String(total);

  var percent = total > 0 ? (idx / total) * 100 : 0;
  document.getElementById("progressInner").style.width = percent + "%";
}

function showCurrentQuestion() {
  var feedbackEl = document.getElementById("feedback");
  feedbackEl.textContent = "";

  if (currentIndex >= questions.length) {
    endExercise();
    return;
  }

  var q = questions[currentIndex];
  var questionTextEl = document.getElementById("questionText");
  var questionHelpEl = document.getElementById("questionHelp");
  var answerArea = document.getElementById("answerArea");

  answerArea.innerHTML = "";

  if (q.type === "direct") {
    questionTextEl.textContent = q.a + " √ó " + q.b + " = ?";
    questionHelpEl.textContent = "√âcris le r√©sultat puis appuie sur Entr√©e ou sur Valider.";

    var input = document.createElement("input");
    input.type = "number";
    input.id = "childAnswer";
    input.placeholder = "Ta r√©ponse";

    var btn = document.createElement("button");
    btn.textContent = "Valider";
    btn.onclick = checkDirectAnswer;

    answerArea.appendChild(input);
    answerArea.appendChild(btn);

    input.onkeydown = function(e) {
      e = e || window.event;
      if (e.key === "Enter" || e.keyCode === 13) {
        checkDirectAnswer();
      }
    };

    input.focus();
  } else {
    questionTextEl.textContent = "Quel calcul donne " + q.result + " ?";
    questionHelpEl.textContent = "Clique sur la bonne op√©ration.";

    var grid = document.createElement("div");
    grid.className = "quiz-options";

    var i;
    for (i = 0; i < q.options.length; i++) {
      (function(label) {
        var b = document.createElement("button");
        b.textContent = label;
        b.onclick = function() {
          checkOperationAnswer(label);
        };
        grid.appendChild(b);
      })(q.options[i]);
    }

    answerArea.appendChild(grid);
  }

  updateProgress();
}

function checkDirectAnswer() {
  var q = questions[currentIndex];
  var input = document.getElementById("childAnswer");
  if (!input) return;

  var val = input.value.trim();
  var feedbackEl = document.getElementById("feedback");

  if (val === "") {
    feedbackEl.textContent = "√âcris une r√©ponse avant de valider üôÇ";
    return;
  }

  var user = parseInt(val, 10);
  var correct = q.result;

  if (user === correct) {
    feedbackEl.textContent = "Correct ! üéâ";
    score++;
    document.getElementById("score").textContent = String(score);
  } else {
    feedbackEl.textContent = "Incorrect‚Ä¶ La bonne r√©ponse sera not√©e dans les erreurs.";
    mistakesList.push({
      question: q.a + " √ó " + q.b + " = " + correct,
      child: val
    });
  }

  currentIndex++;
  setTimeout(showCurrentQuestion, 600);
}

function checkOperationAnswer(label) {
  var q = questions[currentIndex];
  var feedbackEl = document.getElementById("feedback");

  if (label === q.correctOption) {
    feedbackEl.textContent = "Correct ! üåü";
    score++;
    document.getElementById("score").textContent = String(score);
  } else {
    feedbackEl.textContent = "Non, ce n‚Äôest pas ce calcul-l√†.";
    mistakesList.push({
      question: q.correctOption + " = " + q.result,
      child: label
    });
  }

  currentIndex++;
  setTimeout(showCurrentQuestion, 600);
}

function endExercise() {
  document.getElementById("exerciseSection").style.display = "block";
  document.getElementById("result").style.display = "block";

  var total = questions.length;
  var txt = "Score : " + score + " / " + total;
  document.getElementById("finalScore").textContent = txt;

  var ul = document.getElementById("mistakes");
  var i;
  for (i = 0; i < mistakesList.length; i++) {
    var li = document.createElement("li");
    li.textContent = mistakesList[i].question + " (ta r√©ponse : " + mistakesList[i].child + ")";
    ul.appendChild(li);
  }
}

function restart() {
  location.reload();
}

// ======================== INIT GLOBAL =========================
function init() {
  var savedConfig = loadConfig();
  initTablesUI(savedConfig);
  if (savedConfig) {
    updateSidePanel(savedConfig);
    startExerciseWithConfig(savedConfig);
    document.getElementById("saveStatus").textContent = "R√©glages charg√©s.";
    showTab("child");
  } else {
    showTab("parent");
  }
}

if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", init);
} else {
  init();
}
</script>

</body>
</html>
