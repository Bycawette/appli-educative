<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tables ‚Äì Enfant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --bg-main: #e0f2fe;
      --bg-gradient-1: #eef2ff;
      --bg-gradient-2: #e0f2fe;

      --card-light: #ffffff;
      --card-soft: #f8fafc;

      --accent: #fb923c;
      --accent-strong: #ea580c;
      --accent-soft: #fed7aa;
      --accent-alt: #22c55e;
      --accent-blue: #3b82f6;

      --text-main: #0f172a;
      --text-muted: #64748b;

      --border-subtle: rgba(148, 163, 184, 0.6);

      --radius-lg: 20px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, var(--bg-gradient-1), var(--bg-main)),
        radial-gradient(circle at bottom, var(--bg-gradient-2), #ffffff);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
    }

    /* HEADER */
    header {
      background: linear-gradient(90deg, #1e293b, #0f172a);
      color: #f9fafb;
      padding: 0.8rem 1.4rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.6);
    }

    .header-inner {
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      background: #dbeafe;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #1d4ed8;
    }

    .header-title {
      font-size: 1.1rem;
      font-weight: 650;
    }

    .header-sub {
      font-size: 0.85rem;
      color: #cbd5f5;
    }

    .header-right a {
      text-decoration: none;
    }

    .btn-retour {
      border: none;
      padding: 0.4rem 1rem;
      border-radius: var(--radius-pill);
      background: radial-gradient(circle at top left, rgba(59,130,246,0.3), rgba(15, 23, 42, 1));
      color: #e0f2fe;
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    .btn-retour span.icon {
      font-size: 1rem;
    }

    main {
      flex: 1;
      padding: 1.3rem 1rem 1.8rem;
    }

    .page {
      max-width: 980px;
      margin: 0 auto;
    }

    /* HERO */
    .hero {
      background: var(--card-light);
      border-radius: 22px;
      border: 1px solid var(--border-subtle);
      padding: 0.9rem 1.1rem;
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      align-items: center;
      justify-content: space-between;
    }

    .hero-text {
      max-width: 460px;
      font-size: 0.95rem;
    }

    .hero-text strong {
      font-size: 1.05rem;
    }

    .hero-badge {
      background: #eff6ff;
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: #1d4ed8;
      border: 1px solid rgba(129,140,248,0.7);
    }

    /* CARD ENTRAINEMENT */
    .card {
      background: var(--card-light);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 1.1rem 1.2rem 1.2rem;
      margin-bottom: 1rem;
    }

    .card h2 {
      margin: 0 0 0.4rem;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .card h2 span.icon {
      font-size: 1.25rem;
    }

    .card p {
      margin: 0.3rem 0;
      font-size: 0.95rem;
    }

    /* LAYOUT ENFANT */
    .child-layout {
      display: grid;
      grid-template-columns: minmax(0,1.25fr) minmax(0,0.9fr);
      gap: 1rem;
      margin-top: 0.5rem;
    }

    @media (max-width: 820px) {
      .child-layout {
        grid-template-columns: 1fr;
      }
    }

    .child-main {
      background: var(--card-soft);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 0.9rem 1rem 1rem;
    }

    .child-side {
      background: #f1f5f9;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 0.9rem 1rem 1rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .child-side-title {
      font-size: 0.95rem;
      font-weight: 650;
      margin-bottom: 0.3rem;
    }

    .child-side-line {
      margin: 0.2rem 0;
    }

    .child-side-line span.label {
      font-weight: 600;
      color: var(--text-main);
    }

    /* INFO BAR + PROGRESSION */
    .info-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .info-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: #eff6ff;
      border-radius: 999px;
      padding: 0.2rem 0.7rem;
      border: 1px solid rgba(148,163,184,0.8);
    }

    .info-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .progress {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 999px;
      overflow: hidden;
      margin: 0.6rem 0 0.8rem;
    }

    .progress-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), #facc15);
      transition: width 0.2s ease-out;
    }

    #questionText {
      font-size: 1.3rem;
      font-weight: 700;
      margin-top: 0.3rem;
    }

    #questionHelp {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    #answerArea {
      margin-top: 0.7rem;
    }

    #answerArea input[type="number"] {
      max-width: 120px;
      padding: 0.4rem 0.6rem;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.9);
      background: #ffffff;
      font-size: 0.95rem;
      margin-right: 0.5rem;
    }

    #answerArea input[type="number"]:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 1px rgba(251,146,60,0.7);
    }

    /* Boutons */
    button {
      border-radius: var(--radius-pill);
      border: none;
      padding: 0.48rem 1.1rem;
      background: linear-gradient(120deg, var(--accent), var(--accent-strong));
      color: #fefce8;
      font-weight: 650;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .quiz-options {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 0.5rem;
    }

    .quiz-options button {
      width: 100%;
    }

    #feedback {
      margin-top: 0.6rem;
      font-weight: 600;
      min-height: 1.2rem;
    }

    /* RESULTATS */
    #result {
      display: none;
    }

    #finalScore {
      font-size: 1rem;
      font-weight: 650;
      margin-bottom: 0.4rem;
    }

    #mistakes {
      padding-left: 1.2rem;
      font-size: 0.9rem;
    }

    #mistakes li {
      margin-bottom: 0.2rem;
    }

    a:focus-visible,
    button:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--accent-blue);
      outline-offset: 2px;
    }
  </style>
</head>

<body>

<header>
  <div class="header-inner">
    <div class="header-left">
      <div class="header-icon">‚úñÔ∏è</div>
      <div>
        <div class="header-title">Tables de multiplication ‚Äì Enfant</div>
        <div class="header-sub">R√©ponds aux questions pr√©par√©es par ton parent.</div>
      </div>
    </div>
    <div class="header-right">
      <a href="enfant_index.html">
        <button class="btn-retour" type="button">
          <span class="icon">‚üµ</span>
          <span>Retour √† l'accueil enfant</span>
        </button>
      </a>
    </div>
  </div>
</header>

<main>
  <div class="page">

    <section class="hero">
      <div class="hero-text">
        <strong>Entra√Ænement aux tables</strong><br>
        Ton parent a pr√©par√© une mission de tables pour toi. R√©ponds aux questions du mieux que tu peux,
        tu verras ton score et les questions √† retravailler √† la fin.
      </div>
      <div class="hero-badge">
        <span>üéÆ</span>
        <span>Mode jeu activ√©</span>
      </div>
    </section>

    <section class="card" id="exerciseSection">
      <h2><span class="icon">üß†</span> Entra√Ænement</h2>
      <p>R√©ponds aux questions de tables de multiplication. Parfois tu dois donner le r√©sultat, parfois trouver le bon calcul.</p>

      <div class="child-layout">
        <div class="child-main">
          <div class="info-bar">
            <div class="info-pill">
              <span class="dot"></span>
              <span>Question <span id="questionIndex">0</span> / <span id="questionTotal">0</span></span>
            </div>
            <div class="info-pill">
              <span class="dot" style="background: var(--accent-alt);"></span>
              <span>Score : <span id="score">0</span></span>
            </div>
          </div>

          <div class="progress">
            <div class="progress-inner" id="progressInner"></div>
          </div>

          <p id="questionText">Les questions vont commencer‚Ä¶</p>
          <p id="questionHelp"></p>

          <div id="answerArea"></div>

          <p id="feedback"></p>
        </div>

        <div class="child-side">
          <div class="child-side-title">Profil de la mission</div>
          <p class="child-side-line">
            <span class="label">Tables :</span>
            <span id="sideTables">‚Äì</span>
          </p>
          <p class="child-side-line">
            <span class="label">Type de questions :</span>
            <span id="sideMode">‚Äì</span>
          </p>
          <p class="child-side-line">
            <span class="label">Facteur max :</span>
            <span id="sideMaxFactor">‚Äì</span>
          </p>
          <p class="child-side-line">
            <span class="label">Nombre de questions :</span>
            <span id="sideNbQuestions">‚Äì</span>
          </p>
        </div>
      </div>
    </section>

    <section class="card" id="result">
      <h2><span class="icon">üèÅ</span> R√©sultat de la mission</h2>
      <p id="finalScore"></p>
      <p><strong>Questions √† retravailler :</strong></p>
      <ul id="mistakes"></ul>
      <button type="button" onclick="restart()">Recommencer une mission</button>
    </section>

  </div>
</main>

<script>
  const CONFIG_KEY = "tablesConfig_v1";

  function loadConfig() {
    const saved = localStorage.getItem(CONFIG_KEY);
    if (!saved) return null;
    try {
      return JSON.parse(saved);
    } catch (e) {
      return null;
    }
  }

  function defaultConfig() {
    return {
      tables: [1,2,3,4,5,6,7,8,9,10],
      mode: "mixte",
      nbQuestions: 15,
      maxFactor: 10
    };
  }

  function updateSidePanel(config) {
    document.getElementById("sideTables").textContent = config.tables.join(", ");
    let modeText = "Mixte";
    if (config.mode === "direct") modeText = "Questions directes";
    if (config.mode === "operation") modeText = "Chercher l‚Äôop√©ration";
    document.getElementById("sideMode").textContent = modeText;
    document.getElementById("sideMaxFactor").textContent = config.maxFactor;
    document.getElementById("sideNbQuestions").textContent = config.nbQuestions;
  }

  // -------- LOGIQUE DE JEU --------
  let questions = [];
  let currentIndex = 0;
  let score = 0;
  let mistakesList = [];

  function randChoice(arr) {
    const idx = Math.floor(Math.random() * arr.length);
    return arr[idx];
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function generateDirectQuestion(tables, maxFactor) {
    const a = randChoice(tables);
    const b = 1 + Math.floor(Math.random() * maxFactor);
    return {
      type: "direct",
      a: a,
      b: b,
      result: a * b
    };
  }

  function generateOperationQuestion(tables, maxFactor) {
    const base = generateDirectQuestion(tables, maxFactor);
    const correctLabel = base.a + " √ó " + base.b;

    const optionsSet = {};
    const optionsArr = [];

    function addOption(label) {
      if (!optionsSet[label]) {
        optionsSet[label] = true;
        optionsArr.push(label);
      }
    }

    addOption(correctLabel);

    while (optionsArr.length < 4) {
      const fake = generateDirectQuestion(tables, maxFactor);
      addOption(fake.a + " √ó " + fake.b);
    }

    shuffleArray(optionsArr);

    return {
      type: "operation",
      a: base.a,
      b: base.b,
      result: base.result,
      options: optionsArr,
      correctOption: correctLabel
    };
  }

  function buildQuestions(config) {
    const list = [];
    for (let i = 0; i < config.nbQuestions; i++) {
      let typeToUse = config.mode;
      if (config.mode === "mixte") {
        typeToUse = Math.random() < 0.5 ? "direct" : "operation";
      }
      if (typeToUse === "direct") {
        list.push(generateDirectQuestion(config.tables, config.maxFactor));
      } else {
        list.push(generateOperationQuestion(config.tables, config.maxFactor));
      }
    }
    return list;
  }

  function startExerciseWithConfig(config) {
    questions = buildQuestions(config);
    currentIndex = 0;
    score = 0;
    mistakesList = [];

    document.getElementById("score").textContent = "0";
    document.getElementById("questionIndex").textContent = "0";
    document.getElementById("questionTotal").textContent = String(questions.length);
    document.getElementById("feedback").textContent = "";
    document.getElementById("mistakes").innerHTML = "";
    document.getElementById("finalScore").textContent = "";

    document.getElementById("result").style.display = "none";
    document.getElementById("exerciseSection").style.display = "block";

    updateProgress();
    showCurrentQuestion();
  }

  function updateProgress() {
    const total = questions.length;
    const idx = currentIndex;
    document.getElementById("questionIndex").textContent =
      String(idx + 1 <= total ? idx + 1 : total);
    document.getElementById("questionTotal").textContent = String(total);

    const percent = total > 0 ? (idx / total) * 100 : 0;
    document.getElementById("progressInner").style.width = percent + "%";
  }

  function showCurrentQuestion() {
    const feedbackEl = document.getElementById("feedback");
    feedbackEl.textContent = "";

    if (currentIndex >= questions.length) {
      endExercise();
      return;
    }

    const q = questions[currentIndex];
    const questionTextEl = document.getElementById("questionText");
    const questionHelpEl = document.getElementById("questionHelp");
    const answerArea = document.getElementById("answerArea");

    answerArea.innerHTML = "";

    if (q.type === "direct") {
      questionTextEl.textContent = q.a + " √ó " + q.b + " = ?";
      questionHelpEl.textContent = "√âcris le r√©sultat puis appuie sur Entr√©e ou sur Valider.";

      const input = document.createElement("input");
      input.type = "number";
      input.id = "childAnswer";
      input.placeholder = "Ta r√©ponse";

      const btn = document.createElement("button");
      btn.textContent = "Valider";
      btn.onclick = checkDirectAnswer;

      answerArea.appendChild(input);
      answerArea.appendChild(btn);

      input.onkeydown = function(e) {
        e = e || window.event;
        if (e.key === "Enter" || e.keyCode === 13) {
          checkDirectAnswer();
        }
      };

      input.focus();
    } else {
      questionTextEl.textContent = "Quel calcul donne " + q.result + " ?";
      questionHelpEl.textContent = "Clique sur la bonne op√©ration.";

      const grid = document.createElement("div");
      grid.className = "quiz-options";

      q.options.forEach(function(label) {
        const b = document.createElement("button");
        b.textContent = label;
        b.onclick = function() {
          checkOperationAnswer(label);
        };
        grid.appendChild(b);
      });

      answerArea.appendChild(grid);
    }

    updateProgress();
  }

  function checkDirectAnswer() {
    const q = questions[currentIndex];
    const input = document.getElementById("childAnswer");
    if (!input) return;

    const val = input.value.trim();
    const feedbackEl = document.getElementById("feedback");

    if (val === "") {
      feedbackEl.textContent = "√âcris une r√©ponse avant de valider üôÇ";
      return;
    }

    const user = parseInt(val, 10);
    const correct = q.result;

    if (user === correct) {
      feedbackEl.textContent = "Correct ! üéâ";
      score++;
      document.getElementById("score").textContent = String(score);
    } else {
      feedbackEl.textContent = "Incorrect‚Ä¶ La bonne r√©ponse sera not√©e dans les erreurs.";
      mistakesList.push({
        question: q.a + " √ó " + q.b + " = " + correct,
        child: val
      });
    }

    currentIndex++;
    setTimeout(showCurrentQuestion, 600);
  }

  function checkOperationAnswer(label) {
    const q = questions[currentIndex];
    const feedbackEl = document.getElementById("feedback");

    if (label === q.correctOption) {
      feedbackEl.textContent = "Correct ! üåü";
      score++;
      document.getElementById("score").textContent = String(score);
    } else {
      feedbackEl.textContent = "Non, ce n‚Äôest pas ce calcul-l√†.";
      mistakesList.push({
        question: q.correctOption + " = " + q.result,
        child: label
      });
    }

    currentIndex++;
    setTimeout(showCurrentQuestion, 600);
  }

  function endExercise() {
    document.getElementById("exerciseSection").style.display = "block";
    document.getElementById("result").style.display = "block";

    const total = questions.length;
    const txt = "Score : " + score + " / " + total;
    document.getElementById("finalScore").textContent = txt;

    const ul = document.getElementById("mistakes");
    mistakesList.forEach(function(m) {
      const li = document.createElement("li");
      li.textContent = m.question + " (ta r√©ponse : " + m.child + ")";
      ul.appendChild(li);
    });
  }

  function restart() {
    const cfg = loadConfig() || defaultConfig();
    updateSidePanel(cfg);
    startExerciseWithConfig(cfg);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function init() {
    const cfg = loadConfig() || defaultConfig();
    updateSidePanel(cfg);
    startExerciseWithConfig(cfg);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
</script>

</body>
</html>
